schemaVersion: 2.0.0
name: java-openliberty-stack
projects:
  - name: default   
    git:
      location: "https://github.com/groeges/java-openliberty-template-default.git" 
  - name: simple   
    git:
      location: "https://github.com/groeges/java-openliberty-template-simple.git" 
components:
#  - initContainer:
#    name: git-clone
#    image: alpine/git"
#    args:
#      - clone
#      - --single-branch
#      - --
#      - https://github.com/groeges/java-openliberty-stack.git
#      - /stack
#    volumeMounts:
#        - name: stack
#          mountPath: "/stack"
  - container:
      name: java-openliberty-build
      image: kabanero/ubi8-maven:0.3.1
      memoryLimit: 512Mi
      command: ['tail']
      args: [ '-f', '/dev/null']
      endpoints:
        - name: java-openliberty
          configuration:
              protocol: tcp
              scheme: http
          targetPort: 9080
      mountSources: false
      volumeMount:
        - name: stack
          path: /stack
        - name: source
          path: /project/user-app
        - name: maven
          path: /mvn/repository
  - container:
    name: java-openliberty-prod
    image: openliberty/open-liberty:19.0.0.12-kernel-java8-openj9-ubi
    memoryLimit: 512Mi
    command: ['tail']
    args: [ '-f', '/dev/null']
    endpoints:
      - name: java-openliberty
        configuration:
            protocol: tcp
            scheme: http
        targetPort: 9080
    mountSources: false
    volumeMount:
      - name: source
        path: /project/user-app
      - name: maven
        path: /mvn/repository
  - volume:
    name: stack
    size: 1Gi
  - volume:
    name: source
    size: 1Gi
  - volume:
    name: maven
    size: 5Gi  
commands:
  - exec:
      id: init-deps
      name: init image dependancies
      component: java-openliberty-build
      workdir: /project
      commandLine: /project/bin/init-stack.sh
      runAsUser: root # This is not currently part of the devfile schema but may be needed
 - exec:
      id: stack-prep
      name: stack-prep
      component: java-openliberty-build
      workdir: /project/user-app
      commandLine: /project/bin/run-stack.sh prep
      runAsUser: java_user # This is not currently part of the devfile schema but may be needed
  - composite:
      id: setupContainer
      commands:
        - init-deps
        - stack-prep
      parallel: false
      group:
        name: init
        isDefault: true
  - exec:
      alias: run the app
      component: java-openliberty-build
      commandLine: /stack/bin/run-stack.sh run
      workdir: /project/user-app
      group:
        name: run
        isDefault: true
      runAsUser: java_user # This is not currently part of the devfile schema but may be needed
  - exec:
      alias: run the app (debugging enabled)
      component: java-openliberty-build
      commandLine: /stack/bin/run-stack.sh debug
      workdir: /project/user-app
      group:
        name: debug
        isDefault: true
      runAsUser: java_user # This is not currently part of the devfile schema but may be needed
  - exec:
      alias: run the app test suite
      component: java-openliberty-build
      commandLine: /stack/bin/run-stack.sh test
      workdir: /project/user-app
      group:
        name: test
        isDefault: true
      runAsUser: java_user # This is not currently part of the devfile schema but may be needed
  - exec:
    alias: build the app
    component: java-openliberty-prod # Not sure this is the right container to build
    commandLine: /stack/bin/build.sh
    workdir: /project
  - exec:
    alias: deploy the app
    component: java-openliberty-prod
    commandLine: /stack/bin/deploy.sh
    workdir: /project
  - composite:
    id: buildAndDeploy
    commands:
      - build-app
      - deploy-app
    parallel: false
    group:
      name: deploy
      isDefault: true
      