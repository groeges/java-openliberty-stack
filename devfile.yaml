schemaVersion: 2.0.0
name: java-openliberty-stack
projects:
  - name: default   
    git:
      location: "https://github.com/groeges/java-openliberty-template-default.git" 
  #- name: simple   
  #    git:
  #      location: "git@github.com:appsody/stacks.git" 
  #      branch: "master"
  #      sparseCheckoutDir: "incubator/java-openliberty/templates/simple"
  components:
  - container:
      alias: java-openliberty-build
      name: java-openliberty-build
      image: kabanero/ubi8-maven:0.3.1 
      memoryLimit: 512Mi
      command: ['tail']
      args: [ '-f', '/dev/null']
      mountSources: true
      sourceMapping: "/project/user-app"
      volumes:
        - name: source
          containerPath: /project/user-app
        - name: maven
          containerPath: /mvn/repository
      repoMappings:
        - srcPath: "/project"
          destPath: "/project" 
  - container:
      alias: java-openliberty-run
      name: java-openliberty-run
      image: kabanero/ubi8-maven:0.3.1
      memoryLimit: 512Mi
      command: ['tail']
      args: [ '-f', '/dev/null']
      endpoints:
        - name: java-openliberty
          configuration:
              protocol: tcp
              scheme: http
          targetPort: 9080
      mountSources: false
      volumes:
        - name: source
          containerPath: /project/user-app
        - name: maven
          containerPath: /mvn/repository
commands:
#  - exec:
#      # using the script https://github.com/appsody/stacks/blob/master/incubator/java-openliberty/image/project/run-stack.sh which should be included in the image?
#      name: setup local workspace
#      os:
#        - type: linux
#          commandLine: /.appsody-init.sh
#        - type: windows
#          commandLine: /.appsody-init.bat
#      group:
#        name: initLocal
#        isDefault: true
  - exec:
      id: init-deps
      name: init image dependancies
      component: java-openliberty-build
      commandLine: /project/bin/init-stack.sh
      runAsUser: root # This is not currently part of the devfile schema but may be needed
 - exec:
      id: stack-prep
      name: stack-prep
      component: java-openliberty-build
      commandLine: /project/bin/run-stack.sh prep
      runAsUser: java_user # This is not currently part of the devfile schema but may be needed
  - composite:
      id: setupContainer
      label: Setup container (initialise dependancies and prepare stack)
      commands:
        - init-deps
        - stack-prep
      parallel: false
      group:
        name: init
        isDefault: true
  - exec:
      alias: run the app
      component: java-openliberty-run
      commandLine: /project/bin/run-stack.sh run
      workdir: /project/user-app
      group:
        name: run
        isDefault: true
      runAsUser: java_user # This is not currently part of the devfile schema but may be needed
  - exec:
      alias: run the app (debugging enabled)
      component: java-openliberty-run
      commandLine: /project/bin/run-stack.sh debug
      workdir: /project/user-app
      group:
        name: debug
        isDefault: true
      runAsUser: java_user # This is not currently part of the devfile schema but may be needed
  - exec:
      alias: run the app test suite
      component: java-openliberty-run
      commandLine: /project/bin/run-stack.sh test
      workdir: /project/user-app
      group:
        name: test
        isDefault: true
      runAsUser: java_user # This is not currently part of the devfile schema but may be needed
#  - exec:
#      alias: stop the app
#      component: java-openliberty-project
#      commandLine: >-
#          node_server_pids=$(pgrep -fx '.*nodemon (--inspect )?app.js' | tr "\\n" " ") &&
#          echo "Stopping node server with PIDs: ${node_server_pids}" && 
#          kill -15 ${node_server_pids} &>/dev/null && echo 'Done.'
#      group:
#        name: run
#        isDefault: true
    
